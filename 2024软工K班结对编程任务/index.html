<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿç‚¹åç³»ç»Ÿ</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ç‚¹åç³»ç»Ÿ">
    <meta name="description" content="æ™ºèƒ½å­¦ç”Ÿç‚¹åå’Œæ’åç®¡ç†ç³»ç»Ÿ">
    
    <!-- å›¾æ ‡ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxwYXRoIGQ9Im0xNiA2IDQgMTQiLz4KPHA+YXRoIGQ9Ik0xMiA2djE0Ii8+CjxwYXRoIGQ9Ik04IDZsLTQgMTQiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    
    <!-- æ ·å¼ -->
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* è‡ªå®šä¹‰è¯„åˆ†æŒ‰é’®é¢œè‰² */
        #answer-0-5 {
            background-color: #fff3cd !important;
            border-color: #ffeaa7 !important;
            color: #856404 !important;
        }
        #answer-1 {
            background-color: #d1ecf1 !important;
            border-color: #bee5eb !important;
            color: #0c5460 !important;
        }
        #answer-2 {
            background-color: #e6e6fa !important;
            border-color: #d1c4e9 !important;
            color: #4a148c !important;
        }
        #answer-3 {
            background-color: #d4edda !important;
            border-color: #c3e6cb !important;
            color: #155724 !important;
        }
        
        /* æ‚¬åœæ•ˆæœ */
        #answer-0-5:hover {
            background-color: #ffeaa7 !important;
        }
        #answer-1:hover {
            background-color: #bee5eb !important;
        }
        #answer-2:hover {
            background-color: #d1c4e9 !important;
        }
        #answer-3:hover {
            background-color: #c3e6cb !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="header">
            <h1><i class="fas fa-graduation-cap"></i> ç‚¹åç³»ç»Ÿ</h1>
            <div class="user-info">
                <span>æ¬¢è¿ï¼Œè€å¸ˆ</span>
                <span id="data-status" style="margin-left: 15px; font-size: 12px; color: #666;"></span>
                <button class="logout-btn"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <!-- ä¸»å¯¼èˆªèœå• -->
        <nav class="main-nav">
            <button class="nav-btn active" data-module="attendance">
                <i class="fas fa-user-check"></i>
                <span>ç‚¹å</span>
            </button>
            <button class="nav-btn" data-module="ranking">
                <i class="fas fa-trophy"></i>
                <span>æ’å</span>
            </button>
            <button class="nav-btn" data-module="classes">
                <i class="fas fa-users"></i>
                <span>ç­çº§</span>
            </button>
            <button class="nav-btn" data-module="management">
                <i class="fas fa-cog"></i>
                <span>ç®¡ç†</span>
            </button>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- ç‚¹åæ¨¡å— -->
            <div id="attendance-module" class="module active">
                <div class="module-header">
                    <h2><i class="fas fa-user-check"></i> ç‚¹åç³»ç»Ÿ</h2>
                    <div class="module-actions">
                        <select id="attendance-class-selector" class="form-select">
                            <option value="">é€‰æ‹©ç­çº§</option>
                        </select>
                    </div>
                </div>
                
                <div class="attendance-content">
                    <!-- ç‚¹åæ˜¾ç¤ºåŒºåŸŸ -->
                    <div class="roll-call-display" id="roll-call-display">
                        <div class="current-class-info" id="attendance-class-info">
                            è¯·å…ˆåœ¨ç®¡ç†æ¨¡å—ä¸­é€‰æ‹©ç­çº§
                        </div>
                        
                        <div class="called-student-area" id="called-student-area" style="display: none;">
                            <div class="called-student-card">
                                <div class="student-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="student-info">
                                    <div class="student-name" id="called-student-name">-</div>
                                    <div class="student-id" id="called-student-id">-</div>
                                </div>
                                <div class="attendance-buttons">
                                    <button class="btn btn-success" id="mark-present">
                                        <i class="fas fa-check"></i> å‡ºå¸­
                                    </button>
                                    <button class="btn btn-warning" id="mark-late">
                                        <i class="fas fa-clock"></i> è¿Ÿåˆ°
                                    </button>
                                    <button class="btn btn-danger" id="mark-absent">
                                        <i class="fas fa-times"></i> ç¼ºå¸­
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="roll-call-controls">
                            <div class="main-controls" id="main-controls">
                                <button class="btn btn-primary btn-large" id="start-sequential-call">
                                    <i class="fas fa-list"></i> å…¨éƒ¨æŠ½ç‚¹
                                </button>
                                <button class="btn btn-primary btn-large" id="start-random-call">
                                    <i class="fas fa-random"></i> éšæœºæŠ½ç‚¹
                                </button>
                                <button class="btn btn-success btn-large" id="start-random-question">
                                    <i class="fas fa-question-circle"></i> éšæœºæé—®
                                </button>
                            </div>
                            
                            <div class="active-controls" id="active-controls" style="display: none;">
                                <button class="btn btn-secondary btn-large" id="prev-student">
                                    <i class="fas fa-arrow-left"></i> <span id="prev-button-text">ä¸Šä¸€ä¸ª</span>
                                </button>
                                <button class="btn btn-primary btn-large" id="next-student" style="display: none;">
                                    <i class="fas fa-arrow-right"></i> <span id="next-button-text">å†ç‚¹ä¸€ä¸ª</span>
                                </button>
                                <button class="btn btn-danger" id="cancel-call">
                                    <i class="fas fa-stop"></i> å–æ¶ˆç‚¹å
                                </button>
                            </div>
                            
                            <div class="completion-controls" id="completion-controls" style="display: none;">
                                <div class="completion-message">
                                    <h3><i class="fas fa-check-circle"></i> ç‚¹åå®Œæˆï¼</h3>
                                    <p>æ‰€æœ‰å­¦ç”Ÿéƒ½å·²å®Œæˆç‚¹å</p>
                                </div>
                                <div class="completion-buttons">
                                    <button class="btn btn-secondary btn-large" id="back-to-last">
                                        <i class="fas fa-arrow-left"></i> ä¸Šä¸€ä¸ª
                                    </button>
                                    <button class="btn btn-success btn-large" id="confirm-completion">
                                        <i class="fas fa-check"></i> ç¡®è®¤å®Œæˆ
                                    </button>
                                </div>
                            </div>
                            
                            <!-- éšæœºæé—®æ§åˆ¶ç•Œé¢ -->
                            <div class="question-controls" id="question-controls" style="display: none;">
                                <!-- ä¸»è¦è¯„åˆ†ç•Œé¢ -->
                                <div class="main-evaluation" id="main-evaluation">
                                    <div class="evaluation-section">
                                        <h4>é—®é¢˜å›ç­”è¯„åˆ†ï¼š</h4>
                                        <div class="evaluation-buttons">
                                            <button class="btn btn-warning" id="answer-0-5">
                                                <i class="fas fa-star-half-alt"></i> éƒ¨åˆ†æ­£ç¡® (+0.5åˆ†)
                                            </button>
                                            <button class="btn btn-info" id="answer-1">
                                                <i class="fas fa-star"></i> åŸºæœ¬æ­£ç¡® (+1åˆ†)
                                            </button>
                                            <button class="btn btn-secondary" id="answer-2">
                                                <i class="fas fa-star"></i><i class="fas fa-star"></i> è¾ƒå¥½å›ç­” (+2åˆ†)
                                            </button>
                                            <button class="btn btn-success" id="answer-3">
                                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> ä¼˜ç§€å›ç­” (+3åˆ†)
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="additional-options">
                                        <button class="btn btn-secondary" id="show-repeat-evaluation">
                                            <i class="fas fa-redo"></i> é—®é¢˜é‡å¤è¯„åˆ†
                                        </button>
                                    </div>
                                    
                                    <div class="question-actions">
                                        <button class="btn btn-danger" id="end-question">
                                            <i class="fas fa-stop"></i> ç»“æŸæé—®
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- é—®é¢˜é‡å¤è¯„åˆ†ç•Œé¢ -->
                                <div class="repeat-evaluation" id="repeat-evaluation" style="display: none;">
                                    <div class="evaluation-section">
                                        <h4>é—®é¢˜é‡å¤è¯„åˆ†ï¼š</h4>
                                        <div class="evaluation-buttons">
                                            <button class="btn btn-success" id="repeat-correct">
                                                <i class="fas fa-check"></i> å‡†ç¡®é‡å¤ (+0.5åˆ†)
                                            </button>
                                            <button class="btn btn-danger" id="repeat-incorrect">
                                                <i class="fas fa-times"></i> æœªèƒ½é‡å¤ (-1åˆ†)
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="question-actions">
                                        <button class="btn btn-secondary" id="back-to-main-evaluation">
                                            <i class="fas fa-arrow-left"></i> è¿”å›ä¸»è¯„åˆ†
                                        </button>
                                        <button class="btn btn-danger" id="end-question-from-repeat">
                                            <i class="fas fa-stop"></i> ç»“æŸæé—®
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="attendance-stats">
                        <div class="stat-card">
                            <div class="stat-number">0</div>
                            <div class="stat-label">æ€»äººæ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">0</div>
                            <div class="stat-label">å·²ç‚¹å</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">0</div>
                            <div class="stat-label">å‡ºå¸­</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">0</div>
                            <div class="stat-label">ç¼ºå¸­</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ’åæ¨¡å— -->
            <div id="ranking-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-trophy"></i> æ’åç»Ÿè®¡</h2>
                    <div class="module-actions">
                        <select id="ranking-class-selector" class="form-select">
                            <option value="">é€‰æ‹©ç­çº§</option>
                        </select>
                        <button class="btn btn-secondary" id="toggle-probability-display">
                            <i class="fas fa-eye"></i> æ˜¾ç¤ºæ¦‚ç‡
                        </button>
                        <button class="btn btn-primary" id="export-ranking-excel">
                            <i class="fas fa-download"></i> å¯¼å‡ºExcel
                        </button>
                    </div>
                </div>
                
                <div class="ranking-content">
                    <div class="ranking-chart">
                        <h3><i class="fas fa-chart-bar"></i> å­¦ç”Ÿç§¯åˆ†æ’åå›¾è¡¨</h3>
                        <canvas id="ranking-chart-canvas"></canvas>
                    </div>
                    
                    <div class="ranking-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>å§“å</th>
                                    <th>å­¦å·</th>
                                    <th>ç§¯åˆ†</th>
                                    <th>å‡ºå‹¤çŠ¶æ€</th>
                                    <th>å‡ºå‹¤ç‡</th>
                                    <th id="probability-column" style="display: none;">é€‰ä¸­æ¦‚ç‡</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-tbody">
                                <!-- æ’åæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                        
                        <!-- åˆ†é¡µæ§ä»¶ -->
                        <div class="pagination-container" id="pagination-container" style="display: none;">
                            <div class="pagination-info">
                                <span id="pagination-info-text">æ˜¾ç¤ºç¬¬ 1-10 æ¡ï¼Œå…± 0 æ¡è®°å½•</span>
                            </div>
                            <div class="pagination-controls">
                                <button class="btn btn-secondary pagination-btn" id="prev-page" onclick="changePage(-1)">
                                    <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
                                </button>
                                <div class="page-numbers" id="page-numbers">
                                    <!-- é¡µç æŒ‰é’®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                                </div>
                                <button class="btn btn-secondary pagination-btn" id="next-page" onclick="changePage(1)">
                                    ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç­çº§æ¨¡å— -->
            <div id="classes-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-users"></i> ç­çº§ç®¡ç†</h2>
                    <div class="module-actions">
                        <button class="btn btn-primary" id="add-class-main">
                            <i class="fas fa-plus"></i> æ·»åŠ ç­çº§
                        </button>
                    </div>
                </div>
                
                <div class="classes-content">
                    <div class="classes-grid" id="classes-grid">
                        <!-- ç­çº§åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†æ¨¡å— -->
            <div id="management-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-cog"></i> ç³»ç»Ÿç®¡ç†</h2>
                </div>
                
                <div class="management-content">
                    <div class="management-sections">
                        <div class="management-section">
                            <h3><i class="fas fa-graduation-cap"></i> ç­çº§ç®¡ç†</h3>
                            <div class="section-actions">
                                <button class="btn btn-primary" id="add-class">
                                    <i class="fas fa-plus"></i> æ·»åŠ ç­çº§
                                </button>
                                <select id="class-selector" class="form-select" style="margin-left: 10px; min-width: 150px;">
                                    <option value="">é€‰æ‹©ç­çº§</option>
                                </select>
                            </div>
                            <div class="class-management-list" id="class-management-list">
                                <!-- ç­çº§ç®¡ç†åˆ—è¡¨ -->
                            </div>
                        </div>

                        <div class="management-section">
                            <h3><i class="fas fa-users"></i> å­¦ç”Ÿç®¡ç†</h3>
                            <div class="section-actions">
                                <div class="current-class-info" id="current-class-info" style="margin-bottom: 10px; font-weight: bold; color: #667eea;">
                                    è¯·å…ˆé€‰æ‹©ç­çº§
                                </div>
                                <button class="btn btn-primary" id="add-student" disabled>
                                    <i class="fas fa-user-plus"></i> æ·»åŠ å­¦ç”Ÿ
                                </button>
                                <button class="btn btn-secondary" id="import-students" disabled>
                                    <i class="fas fa-file-import"></i> æ‰¹é‡å¯¼å…¥
                                </button>
                                <button class="btn btn-secondary" id="generate-excel">
                                    <i class="fas fa-file-excel"></i> ç”Ÿæˆæµ‹è¯•Excel
                                </button>
                                <button class="btn btn-warning" onclick="initializeStudentData()">
                                    <i class="fas fa-sync-alt"></i> åˆå§‹åŒ–å­¦ç”Ÿæ•°æ®
                                </button>
                            </div>
                            <div class="student-management-list" id="student-management-list">
                                <!-- å­¦ç”Ÿç®¡ç†åˆ—è¡¨ -->
                            </div>
                        </div>

                        <div class="management-section">
                            <h3><i class="fas fa-chart-bar"></i> æ•°æ®ç»Ÿè®¡</h3>
                            <div class="stats-overview">
                                <div class="overview-card">
                                    <div class="overview-number">0</div>
                                    <div class="overview-label">æ€»ç­çº§æ•°</div>
                                </div>
                                <div class="overview-card">
                                    <div class="overview-number">0</div>
                                    <div class="overview-label">æ€»å­¦ç”Ÿæ•°</div>
                                </div>
                                <div class="overview-card">
                                    <div class="overview-number">0</div>
                                    <div class="overview-label">æœ¬å‘¨ç‚¹åæ¬¡æ•°</div>
                                </div>
                            </div>
                        </div>

                        <div class="management-section">
                            <h3><i class="fas fa-cogs"></i> ç³»ç»Ÿè®¾ç½®</h3>
                            <div class="settings-form">
                                <div class="form-group">
                                    <label>è‡ªåŠ¨ä¿å­˜é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                                    <input type="number" class="form-input" value="5" min="1" max="60">
                                </div>
                                <div class="form-group">
                                    <label>é»˜è®¤å‡ºå‹¤çŠ¶æ€</label>
                                    <select class="form-select">
                                        <option value="present">å‡ºå¸­</option>
                                        <option value="absent">ç¼ºå¸­</option>
                                        <option value="unknown">æœªçŸ¥</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div id="modal-body">
                <!-- æ¨¡æ€æ¡†å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="script.js"></script>
    
    <!-- PWA Service Worker æ³¨å†Œ -->
    <script>
        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                        
                        // æ£€æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨
                                    if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // å®‰è£…æç¤º
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // æ˜¾ç¤ºå®‰è£…æç¤º
            const installBanner = document.createElement('div');
            installBanner.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #667eea; color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; max-width: 300px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-download"></i>
                        <div>
                            <div style="font-weight: bold; margin-bottom: 5px;">å®‰è£…åº”ç”¨</div>
                            <div style="font-size: 12px; opacity: 0.9;">å°†æ­¤åº”ç”¨å®‰è£…åˆ°æ¡Œé¢ï¼Œè·å¾—æ›´å¥½çš„ä½“éªŒ</div>
                        </div>
                        <button id="install-btn" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-left: 10px;">å®‰è£…</button>
                        <button id="close-banner" style="background: none; border: none; color: white; cursor: pointer; padding: 5px;">Ã—</button>
                    </div>
                </div>
            `;
            document.body.appendChild(installBanner);
            
            // å®‰è£…æŒ‰é’®äº‹ä»¶
            document.getElementById('install-btn').addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…æç¤º');
                    }
                    deferredPrompt = null;
                    installBanner.remove();
                });
            });
            
            // å…³é—­æŒ‰é’®äº‹ä»¶
            document.getElementById('close-banner').addEventListener('click', () => {
                installBanner.remove();
            });
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (installBanner.parentNode) {
                    installBanner.remove();
                }
            }, 10000);
        });

        // å®‰è£…æˆåŠŸåçš„å¤„ç†
        window.addEventListener('appinstalled', (evt) => {
            console.log('åº”ç”¨å·²å®‰è£…');
            if (typeof showNotification === 'function') {
                showNotification('åº”ç”¨å·²æˆåŠŸå®‰è£…åˆ°æ¡Œé¢ï¼', 'success');
            }
        });
    </script>
</body>
</html>
